---
- hosts: "{{ target_group }}"
  become: true
  vars:
    ansible_python_interpreter: auto_silent
  tasks:
    - name: Update package list
      apt:
        update_cache: yes
        upgrade: dist
      register: apt_update
      retries: 5
      delay: 30
      until: apt_update is succeeded
    
    - name: Clean apt cache to free disk space
      apt:
        autoclean: yes
      when: apt_update is succeeded
    
    - name: Remove orphaned packages
      apt:
        autoremove: yes
      when: apt_update is succeeded
    
    - name: Display disk usage after cleanup
      shell: df -h / | tail -1
      register: disk_usage
    
    - name: Check Jellyfin cache size
      shell: du -sh /media/servarr/jellyfin/config/cache/ 2>/dev/null || echo "Cache not accessible"
      register: jellyfin_cache_size
      ignore_errors: yes
    
    - name: Show disk usage and cache info
      debug:
        msg: 
          - "Disk usage after updates: {{ disk_usage.stdout }}"
          - "Jellyfin cache size: {{ jellyfin_cache_size.stdout }}"