---
- name: Sequentially update and upgrade PVE nodes with Ceph health check
  hosts: proxmox
  serial: 1
  become: yes
  vars:
    ceph_health_command: 'ceph health'
    ceph_health_ok: 'HEALTH_OK'
  tasks:
    - name: Simulate apt-get dist-upgrade
      shell: apt-get dist-upgrade -s || true
      register: apt_dist_upgrade_sim_result
      changed_when: false
      failed_when: false

    - name: Debug apt-get dist-upgrade -s output
      debug:
        var: apt_dist_upgrade_sim_result.stdout_lines

    - name: Simulate apt-get --just-print upgrade
      shell: apt-get --just-print upgrade || true
      register: apt_just_print_upgrade_result
      changed_when: false
      failed_when: false

    - name: Debug apt-get --just-print upgrade output
      debug:
        var: apt_just_print_upgrade_result.stdout_lines
    - name: Run pveupgrade (if available)
      shell: pveupgrade || echo 'pveupgrade not found'
      register: pveupgrade_result
      changed_when: false
      failed_when: false

    - name: Debug pveupgrade output
      debug:
        var: pveupgrade_result.stdout_lines

    - name: Simulate apt-get upgrade
      shell: apt-get upgrade -s || true
      register: apt_upgrade_sim_result
      changed_when: false
      failed_when: false


    - name: Update Proxmox nodes
      hosts: proxmox
      become: true
      gather_facts: false
      serial: 1

      tasks:
        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: true
            cache_valid_time: 3600

        - name: Perform full-upgrade (dist-upgrade equivalent)
          ansible.builtin.apt:
            upgrade: full
            autoclean: true
            autoremove: true
          register: apt_status

        # - name: Reboot the host if required
        #   ansible.builtin.shell: "sleep 5 && /sbin/shutdown -r now"
        #   args:
        #     chdir: /
        #   async: 1
        #   poll: 0
        #   when: apt_status.changed and (apt_status.reboot_required | default(false))

        # - name: Wait for the host to come back online
        #   ansible.builtin.wait_for:
        #     port: 22
        #     host: "{{ inventory_hostname }}"
        #     state: started
        #     delay: 30
        #     timeout: 300
        #   when: apt_status.changed and (apt_status.reboot_required | default(false))

        # - name: Re-gather facts after reboot to confirm connectivity and state
        #   ansible.builtin.setup:
        #   when: apt_status.changed and (apt_status.reboot_required | default(false))

