---
    - name: Update Proxmox nodes
      hosts: proxmox
      become: true
      gather_facts: false
      serial: 1
      tasks:
        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: true
            cache_valid_time: 3600

        - name: Perform full-upgrade (dist-upgrade equivalent)
          ansible.builtin.apt:
            upgrade: full
            autoclean: true
            autoremove: true
          register: apt_status

        # - name: Reboot the host if required
        #   ansible.builtin.shell: "sleep 5 && /sbin/shutdown -r now"
        #   args:
        #     chdir: /
        #   async: 1
        #   poll: 0
        #   when: apt_status.changed and (apt_status.reboot_required | default(false))

        # - name: Wait for the host to come back online
        #   ansible.builtin.wait_for:
        #     port: 22
        #     host: "{{ inventory_hostname }}"
        #     state: started
        #     delay: 30
        #     timeout: 300
        #   when: apt_status.changed and (apt_status.reboot_required | default(false))

        # - name: Re-gather facts after reboot to confirm connectivity and state
        #   ansible.builtin.setup:
        #   when: apt_status.changed and (apt_status.reboot_required | default(false))

