---
- name: Update Proxmox nodes
  hosts: proxmox
  become: true
  gather_facts: false
  serial: 1
  tasks:
    - name: Show upgradable packages (apt list --upgradable)
      ansible.builtin.shell: apt list --upgradable | sed '/Listing.../d'
      register: apt_list_upgradable_result

    - name: Debug upgradable packages (apt list --upgradable)
      ansible.builtin.debug:
        var: apt_list_upgradable_result.stdout_lines
    - name: Show current user (whoami)
      ansible.builtin.shell: whoami
      register: whoami_result

    - name: Debug whoami
      ansible.builtin.debug:
        var: whoami_result.stdout

    - name: Show user info (id -a)
      ansible.builtin.shell: id -a
      register: id_result

    - name: Debug id -a
      ansible.builtin.debug:
        var: id_result.stdout

    - name: Show environment variables
      ansible.builtin.shell: env
      register: env_result

    - name: Debug environment variables
      ansible.builtin.debug:
        var: env_result.stdout_lines

    - name: Show apt binary location
      ansible.builtin.shell: which apt
      register: which_apt_result

    - name: Debug which apt
      ansible.builtin.debug:
        var: which_apt_result.stdout

    - name: Show apt config dump
      ansible.builtin.shell: apt-config dump
      register: apt_config_result

    - name: Debug apt config dump
      ansible.builtin.debug:
        var: apt_config_result.stdout_lines

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600


    - name: Run apt update (for debug)
      ansible.builtin.shell: apt update
      register: apt_update_result
      changed_when: false

    - name: Debug apt update output
      ansible.builtin.debug:
        var: apt_update_result.stdout_lines

    - name: Show upgradable packages (apt list --upgradable, no sed, capture stderr)
      ansible.builtin.shell: apt list --upgradable 2>&1
      register: apt_list_upgradable_all_result
      changed_when: false

    - name: Debug upgradable packages (apt list --upgradable, no sed)
      ansible.builtin.debug:
        var: apt_list_upgradable_all_result.stdout_lines

    - name: Show upgradable packages (apt list --upgradable | sed '1d')
      ansible.builtin.shell: apt list --upgradable 2>/dev/null | sed '1d'
      register: apt_list_upgradable_result_sed
      changed_when: false

    - name: Debug upgradable packages (apt list --upgradable | sed '1d')
      ansible.builtin.debug:
        var: apt_list_upgradable_result_sed.stdout_lines

    - name: Simulate dist-upgrade to show upgradable packages
      ansible.builtin.shell: apt-get -s dist-upgrade
      register: dist_upgrade_sim_result

    - name: Show upgradable packages from dist-upgrade simulation
      ansible.builtin.debug:
        var: dist_upgrade_sim_result.stdout_lines



    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file

    - name: Show if reboot is required
      ansible.builtin.debug:
        msg: "Reboot required: {{ reboot_required_file.stat.exists }}"

    - name: Pause for confirmation before upgrade
      pause:
        prompt: Do you want to upgrade the above packages? Press enter to continue, or Ctrl+c and then 'a' to abort.
      when: dist_upgrade_sim_result.stdout is not search('0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.')

    - name: Install apt upgrades
      ansible.builtin.apt:
        upgrade: full
        autoremove: true
        autoclean: true
      register: apt_upgrade_result

