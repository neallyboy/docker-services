---
- hosts: "{{ target_group }}"
  become: true
  vars:
    ansible_python_interpreter: auto_silent
  tasks:
    - name: Copy Jellyfin cache cleanup script
      copy:
        src: ../scripts/jellyfin-cache-cleanup.sh
        dest: /usr/local/bin/jellyfin-cache-cleanup.sh
        mode: '0755'
        owner: root
        group: root
    
    - name: Create systemd timer for Jellyfin cache cleanup
      copy:
        content: |
          [Unit]
          Description=Jellyfin Cache Cleanup
          
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/jellyfin-cache-cleanup.sh
          User=root
        dest: /etc/systemd/system/jellyfin-cache-cleanup.service
        mode: '0644'
    
    - name: Create systemd timer for daily cache cleanup
      copy:
        content: |
          [Unit]
          Description=Run Jellyfin cache cleanup daily
          Requires=jellyfin-cache-cleanup.service
          
          [Timer]
          OnCalendar=daily
          Persistent=true
          
          [Install]
          WantedBy=timers.target
        dest: /etc/systemd/system/jellyfin-cache-cleanup.timer
        mode: '0644'
    
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes
    
    - name: Enable and start Jellyfin cache cleanup timer
      systemd:
        name: jellyfin-cache-cleanup.timer
        enabled: yes
        state: started
    
    - name: Run initial cache cleanup
      command: /usr/local/bin/jellyfin-cache-cleanup.sh
      register: cleanup_result
    
    - name: Display cleanup results
      debug:
        msg: "{{ cleanup_result.stdout_lines }}"
